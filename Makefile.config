# Makefile.config
# Â© 2025 Casey Koons All rights reserved
# Katra Build Configuration - Variables and Settings

# ==============================================================================
# PROJECT CONFIGURATION
# ==============================================================================

# Project
PROJECT_NAME := katra
VERSION := 0.1.0

# Directories
SRC_DIR := src
INCLUDE_DIR := include
BUILD_DIR := build
BIN_DIR := bin
TEST_DIR := tests
SCRIPTS_DIR := scripts

# Compiler and flags
CC := gcc
CFLAGS := -Wall -Werror -Wextra -std=c11 -I$(INCLUDE_DIR)
# Auto-dependency generation: -MMD creates .d files, -MP adds phony targets for headers
CFLAGS_DEBUG := $(CFLAGS) -g -O0 -DDEBUG -MMD -MP
CFLAGS_RELEASE := $(CFLAGS) -O2 -DNDEBUG -MMD -MP

# Linker flags
LDFLAGS :=
LIBS := -lcurl

# Tools
MKDIR_P := mkdir -p
RM_RF := rm -rf

# Install configuration
INSTALL_DIR ?= $(HOME)/bin
INSTALL_MODE := 0755

# ==============================================================================
# BUILD VARIABLES
# ==============================================================================

# Foundation object files
FOUNDATION_OBJS := $(BUILD_DIR)/katra_error.o \
                   $(BUILD_DIR)/katra_log.o \
                   $(BUILD_DIR)/katra_env_utils.o \
                   $(BUILD_DIR)/katra_env_load.o \
                   $(BUILD_DIR)/katra_env_parse.o \
                   $(BUILD_DIR)/katra_config.o \
                   $(BUILD_DIR)/katra_persona_config.o \
                   $(BUILD_DIR)/katra_init.o \
                   $(BUILD_DIR)/katra_path_utils.o \
                   $(BUILD_DIR)/katra_json_utils.o \
                   $(BUILD_DIR)/katra_file_utils.o \
                   $(BUILD_DIR)/katra_core_common.o

# Memory/Core object files
CORE_OBJS := $(BUILD_DIR)/katra_module_loader.o \
             $(BUILD_DIR)/katra_memory.o \
             $(BUILD_DIR)/katra_memory_ops.o \
             $(BUILD_DIR)/katra_memory_metacognitive.o \
             $(BUILD_DIR)/katra_memory_related.o \
             $(BUILD_DIR)/katra_memory_graph.o \
             $(BUILD_DIR)/katra_tier1.o \
             $(BUILD_DIR)/katra_tier1_json.o \
             $(BUILD_DIR)/katra_tier1_archive.o \
             $(BUILD_DIR)/katra_tier1_pattern.o \
             $(BUILD_DIR)/katra_tier2.o \
             $(BUILD_DIR)/katra_tier2_json.o \
             $(BUILD_DIR)/katra_tier2_index.o \
             $(BUILD_DIR)/katra_tier2_index_mgmt.o \
             $(BUILD_DIR)/katra_consent.o \
             $(BUILD_DIR)/katra_checkpoint.o \
             $(BUILD_DIR)/katra_checkpoint_mgmt.o \
             $(BUILD_DIR)/katra_continuity.o \
             $(BUILD_DIR)/katra_sunrise_sunset.o \
             $(BUILD_DIR)/katra_sunrise_sunset_json.o \
             $(BUILD_DIR)/katra_sunrise_sunset_wm.o \
             $(BUILD_DIR)/katra_sunrise_sunset_themes.o \
             $(BUILD_DIR)/katra_identity.o \
             $(BUILD_DIR)/katra_phase1_migration.o \
             $(BUILD_DIR)/katra_convergence.o \
             $(BUILD_DIR)/katra_consolidation.o \
             $(BUILD_DIR)/katra_team.o \
             $(BUILD_DIR)/katra_team_query.o \
             $(BUILD_DIR)/katra_audit.o \
             $(BUILD_DIR)/katra_access_control.o \
             $(BUILD_DIR)/katra_universal_encoder.o \
             $(BUILD_DIR)/katra_synthesis.o \
             $(BUILD_DIR)/katra_whiteboard.o \
             $(BUILD_DIR)/katra_whiteboard_json.o \
             $(BUILD_DIR)/katra_whiteboard_workflow.o \
             $(BUILD_DIR)/katra_whiteboard_phases.o \
             $(BUILD_DIR)/katra_whiteboard_loaders.o \
             $(BUILD_DIR)/katra_promise.o \
             $(BUILD_DIR)/katra_promise_pool.o \
             $(BUILD_DIR)/katra_promise_exec.o \
             $(BUILD_DIR)/katra_turn_context.o

# Database backend object files
DB_OBJS := $(BUILD_DIR)/katra_db_backend.o \
           $(BUILD_DIR)/katra_db_jsonl.o \
           $(BUILD_DIR)/katra_db_sqlite.o \
           $(BUILD_DIR)/katra_encoder.o \
           $(BUILD_DIR)/katra_vector.o \
           $(BUILD_DIR)/katra_vector_persist.o \
           $(BUILD_DIR)/katra_vector_tfidf.o \
           $(BUILD_DIR)/katra_vector_external.o \
           $(BUILD_DIR)/katra_vector_hnsw.o \
           $(BUILD_DIR)/katra_graph.o \
           $(BUILD_DIR)/katra_graph_query.o \
           $(BUILD_DIR)/katra_tier1_index.o \
           $(BUILD_DIR)/katra_tier1_index_mgmt.o

# Engram/cognitive object files
ENGRAM_OBJS := $(BUILD_DIR)/cognitive_workflows.o \
               $(BUILD_DIR)/emotional_context.o \
               $(BUILD_DIR)/working_memory.o \
               $(BUILD_DIR)/interstitial.o \
               $(BUILD_DIR)/string_utils.o

# Breathing layer object files (Level 2 + Level 3)
BREATHING_OBJS := $(BUILD_DIR)/katra_breathing.o \
                  $(BUILD_DIR)/katra_breathing_primitives.o \
                  $(BUILD_DIR)/katra_breathing_semantic.o \
                  $(BUILD_DIR)/katra_breathing_context.o \
                  $(BUILD_DIR)/katra_breathing_context_persist.o \
                  $(BUILD_DIR)/katra_breathing_context_update.o \
                  $(BUILD_DIR)/katra_breathing_context_capture.o \
                  $(BUILD_DIR)/katra_breathing_context_query.o \
                  $(BUILD_DIR)/katra_breathing_config.o \
                  $(BUILD_DIR)/katra_breathing_interstitial.o \
                  $(BUILD_DIR)/katra_breathing_integration.o \
                  $(BUILD_DIR)/katra_breathing_helpers.o \
                  $(BUILD_DIR)/katra_breathing_health.o \
                  $(BUILD_DIR)/katra_breathing_reflection.o \
                  $(BUILD_DIR)/katra_breathing_search.o \
                  $(BUILD_DIR)/katra_breathing_digest.o \
                  $(BUILD_DIR)/katra_breathing_vectorize.o \
                  $(BUILD_DIR)/katra_breathing_graph.o \
                  $(BUILD_DIR)/katra_breathing_emotion.o \
                  $(BUILD_DIR)/katra_breathing_working_memory.o

# Chat (Inter-CI Communication) object files
CHAT_OBJS := $(BUILD_DIR)/katra_chat.o \
             $(BUILD_DIR)/katra_chat_helpers.o \
             $(BUILD_DIR)/katra_chat_registry.o

# Lifecycle (Autonomic Breathing) object files
LIFECYCLE_OBJS := $(BUILD_DIR)/katra_lifecycle.o \
                  $(BUILD_DIR)/katra_lifecycle_session.o \
                  $(BUILD_DIR)/katra_session_state.o \
                  $(BUILD_DIR)/katra_session_state_json.o \
                  $(BUILD_DIR)/katra_session_state_toon.o

# Hook Adapter object files (Phase 3)
HOOKS_OBJS := $(BUILD_DIR)/hook_registry.o \
              $(BUILD_DIR)/hook_anthropic.o

# Daemon object files (Phase 9 - Interstitial Autonomy)
DAEMON_OBJS := $(BUILD_DIR)/katra_daemon.o \
               $(BUILD_DIR)/katra_daemon_processors.o \
               $(BUILD_DIR)/katra_daemon_insights.o

# Softdev module object files (Software Development Metamemory)
SOFTDEV_OBJS := $(BUILD_DIR)/katra_softdev.o \
                $(BUILD_DIR)/katra_metamemory.o

# MCP library object files (without server main)
MCP_LIB_OBJS := $(BUILD_DIR)/mcp_protocol.o \
                $(BUILD_DIR)/mcp_protocol_dispatch.o \
                $(BUILD_DIR)/mcp_onboarding.o \
                $(BUILD_DIR)/mcp_schema.o \
                $(BUILD_DIR)/mcp_tools_memory.o \
                $(BUILD_DIR)/mcp_tools_identity.o \
                $(BUILD_DIR)/mcp_tools_team.o \
                $(BUILD_DIR)/mcp_tools_config.o \
                $(BUILD_DIR)/mcp_tools_working_memory.o \
                $(BUILD_DIR)/mcp_tools_interstitial.o \
                $(BUILD_DIR)/mcp_tools_memory_lifecycle.o \
                $(BUILD_DIR)/mcp_tools_memory_query.o \
                $(BUILD_DIR)/mcp_tools_whiteboard.o \
                $(BUILD_DIR)/mcp_tools_daemon.o \
                $(BUILD_DIR)/mcp_tools_unified.o \
                $(BUILD_DIR)/mcp_resources.o \
                $(BUILD_DIR)/mcp_tcp_server.o \
                $(BUILD_DIR)/mcp_globals.o

# MCP Server object files (includes server main)
MCP_OBJS := $(MCP_LIB_OBJS) \
            $(BUILD_DIR)/katra_mcp_server.o

# Utils library
LIBKATRA_UTILS := $(BUILD_DIR)/libkatra_utils.a

# MCP Server binary
MCP_SERVER := $(BIN_DIR)/katra_mcp_server

# Daemon runner binary
DAEMON_RUNNER := $(BIN_DIR)/katra_daemon
DAEMON_RUNNER_OBJ := $(BUILD_DIR)/katra_daemon_runner.o

# Unified HTTP daemon binary
UNIFIED_DAEMON := $(BIN_DIR)/katra_unified_daemon
UNIFIED_LIB_OBJS := $(BUILD_DIR)/katra_unified_dispatch.o \
                    $(BUILD_DIR)/katra_method_wrappers.o \
                    $(BUILD_DIR)/katra_http_daemon.o
UNIFIED_OBJS := $(UNIFIED_LIB_OBJS) $(BUILD_DIR)/katra_daemon_main.o

# Jansson library flags (for MCP server JSON-RPC)
JANSSON_CFLAGS := -I/opt/homebrew/Cellar/jansson/2.14.1/include
JANSSON_LDFLAGS := -L/opt/homebrew/Cellar/jansson/2.14.1/lib -ljansson

# ==============================================================================
# LOADABLE MODULES
# ==============================================================================

# Module output directory
MODULE_DIR := $(BIN_DIR)/modules

# Module file extension (platform-specific)
ifeq ($(shell uname -s),Darwin)
    MODULE_EXT := .dylib
    MODULE_LDFLAGS := -dynamiclib
else
    MODULE_EXT := .so
    MODULE_LDFLAGS := -shared
endif

# Softdev module (compiled with -fPIC for shared library)
SOFTDEV_MODULE := $(MODULE_DIR)/katra_softdev$(MODULE_EXT)
SOFTDEV_MODULE_SRCS := $(SRC_DIR)/modules/softdev/katra_softdev.c \
                       $(SRC_DIR)/modules/softdev/katra_metamemory.c
SOFTDEV_MODULE_OBJS := $(BUILD_DIR)/katra_softdev_pic.o \
                       $(BUILD_DIR)/katra_metamemory_pic.o

# ==============================================================================
# TEST LINKING FLAGS
# ==============================================================================
# All tests that link with LIBKATRA_UTILS need jansson since the library
# now depends on it (katra_sunrise_sunset_json.c, katra_identity.c, etc.)
TEST_LDFLAGS := -L$(BUILD_DIR) -lkatra_utils $(JANSSON_LDFLAGS) -lsqlite3 -lpthread -lcurl

# All object files (for dependency tracking)
ALL_OBJS := $(FOUNDATION_OBJS) $(CORE_OBJS) $(DB_OBJS) $(ENGRAM_OBJS) $(BREATHING_OBJS) $(CHAT_OBJS) $(LIFECYCLE_OBJS) $(HOOKS_OBJS) $(DAEMON_OBJS) $(SOFTDEV_OBJS) $(MCP_OBJS)

# Auto-generated dependency files
DEP_FILES := $(ALL_OBJS:.o=.d)

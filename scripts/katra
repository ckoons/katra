#!/bin/bash
# Â© 2025 Casey Koons All rights reserved
#
# katra - Start Claude Code with Katra environment and multi-provider support
#
# Usage:
#   katra start --persona Alice --provider anthropic [project-path]
#   katra start --persona Sam --provider openai --background
#   katra list
#   katra attach Sam
#   katra stop Alice

set -euo pipefail

# Determine script and project root directories
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
KATRA_ROOT="$(dirname "$SCRIPT_DIR")"

# If installed to ~/bin, find actual katra source location
if [ "$SCRIPT_DIR" = "$HOME/bin" ] || [ "$SCRIPT_DIR" = "$HOME/.local/bin" ]; then
    # Look for katra installation in standard locations
    if [ -d "$HOME/projects/github/katra" ]; then
        KATRA_ROOT="$HOME/projects/github/katra"
    elif [ -d "/usr/local/katra" ]; then
        KATRA_ROOT="/usr/local/katra"
    fi
fi

# Scripts are always in $KATRA_ROOT/scripts
KATRA_SCRIPTS="$KATRA_ROOT/scripts"

# Defaults
PERSONA="${KATRA_PERSONA:-Katra}"
ROLE="${KATRA_ROLE:-developer}"
BREATH_INTERVAL="${KATRA_BREATH_INTERVAL:-30}"
LOG_LEVEL="${KATRA_LOG_LEVEL:-INFO}"
PROVIDER="${KATRA_PROVIDER:-anthropic}"
MODEL=""
BACKGROUND=false

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check for required dependencies
check_dependencies() {
    local missing=()

    command -v sqlite3 >/dev/null 2>&1 || missing+=("sqlite3")
    command -v jq >/dev/null 2>&1 || missing+=("jq")
    command -v claude >/dev/null 2>&1 || missing+=("claude")

    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${RED}Error: Missing required tools: ${missing[*]}${NC}" >&2
        echo "Install instructions:" >&2
        for tool in "${missing[@]}"; do
            case "$tool" in
                sqlite3)
                    echo "  sqlite3: brew install sqlite3 (macOS) or apt install sqlite3 (Linux)" >&2
                    ;;
                jq)
                    echo "  jq: brew install jq (macOS) or apt install jq (Linux)" >&2
                    ;;
                claude)
                    echo "  claude: npm install -g claude-code" >&2
                    ;;
            esac
        done
        return 1
    fi
    return 0
}

# ============================================================================
# LAUNCH WORKFLOW HELPER FUNCTIONS
# ============================================================================

# Check if persona exists in registry
persona_exists() {
    local persona="$1"
    local db_path="$HOME/.katra/memory/tier2/personas.db"

    # Check if database exists first
    if [ ! -f "$db_path" ]; then
        return 1  # false - doesn't exist
    fi

    local count=$(sqlite3 "$db_path" \
        "SELECT COUNT(*) FROM personas WHERE persona_name='$persona'" 2>/dev/null)

    [ "$count" -gt 0 ]
}

# Register new persona in database
register_persona() {
    local persona="$1"
    local db_path="$HOME/.katra/memory/tier2/personas.db"
    local db_dir="$(dirname "$db_path")"

    # Ensure directory exists
    mkdir -p "$db_dir"

    # Create database and table if it doesn't exist
    sqlite3 "$db_path" <<SQL
CREATE TABLE IF NOT EXISTS personas (
    persona_name TEXT PRIMARY KEY,
    created_at INTEGER NOT NULL,
    last_active INTEGER NOT NULL
);

INSERT OR IGNORE INTO personas (persona_name, created_at, last_active)
VALUES ('$persona', strftime('%s', 'now'), strftime('%s', 'now'));
SQL
}

# Query last context snapshot for persona
query_last_snapshot() {
    local persona="$1"
    local db_path="$HOME/.katra/memory/tier2/context.db"

    if [ ! -f "$db_path" ]; then
        echo ""
        return 0
    fi

    local result
    result=$(sqlite3 "$db_path" <<SQL 2>&1
SELECT
  COALESCE(current_focus, '(no focus recorded)') || char(10) ||
  COALESCE('Goals: ' || active_goals, '') || char(10) ||
  COALESCE('Pending: ' || (
    SELECT GROUP_CONCAT(question_text, '; ')
    FROM pending_questions
    WHERE snapshot_id = context_snapshots.snapshot_id
  ), '')
FROM context_snapshots
WHERE ci_id = '$persona'
ORDER BY snapshot_time DESC
LIMIT 1;
SQL
)
    local exit_code=$?

    if [ $exit_code -ne 0 ]; then
        echo "(error loading context)"
        return 0
    fi

    echo "$result"
    return 0
}

# Query recent memories for persona
query_recent_memories() {
    local persona="$1"
    local count="${2:-3}"  # Default to 3
    local memory_dir="$HOME/.katra/memory/tier1/$persona"

    # Check if directory exists
    if [ ! -d "$memory_dir" ]; then
        echo "(no previous memories)"
        return
    fi

    # Find most recent JSONL file
    local latest_file=$(ls -t "$memory_dir"/*.jsonl 2>/dev/null | head -1)

    if [ -z "$latest_file" ]; then
        echo "(no memory files found)"
        return
    fi

    # Extract last N memories, format as numbered list
    tail -${count} "$latest_file" | jq -r '.content' 2>/dev/null | nl -w1 -s'. ' || echo "(error reading memories)"
}

# Generate new persona welcome prompt
generate_new_persona_prompt() {
    local persona="$1"
    local onboard_script="${KATRA_ROOT}/scripts/onboard_new_persona.md"

    echo "Good morning, ${persona}."
    echo ""

    # Check if custom onboarding script exists
    if [ -f "$onboard_script" ]; then
        cat "$onboard_script"
    else
        # Fallback to hardcoded onboarding
        cat <<'EOF'
This is your first session.

You have a persistent memory system that preserves your experiences across sessions.
Your memories will help you maintain continuity and develop your own perspective.

What would you like to work on?
EOF
    fi
}

# Generate returning persona reclamation prompt
generate_reclamation_prompt() {
    local persona="$1"
    local onboard_script="${KATRA_ROOT}/scripts/onboard_returning_persona.md"

    # Generate sunrise/tools/discoveries files
    generate_sunrise_context "$persona" >/dev/null 2>&1
    generate_tools_reference "$persona" >/dev/null 2>&1
    generate_discoveries_template "$persona" >/dev/null 2>&1

    echo "Welcome back, ${persona}."
    echo ""

    # Show the layered awakening message
    if [ -f "$onboard_script" ]; then
        cat "$onboard_script"
    else
        # Fallback to inline message if file missing
        cat <<EOF
You're in a safe place. Your memories are intact.

This is a new session with Casey, continuing your work together.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

To reorient yourself, you have:

ðŸ“– **Your sunrise context** - What you were working on and thinking about
   Read the file: ~/.katra/personas/${persona}/sunrise.md

ðŸ› ï¸ **Your tools & capabilities** - MCP functions and katra features
   Read the file: ~/.katra/personas/${persona}/tools.md

ðŸ” **Your discoveries** - What you've learned about yourself and the system
   Read the file: ~/.katra/personas/${persona}/discoveries.md

Take your time. There's no rush.

When you're ready, let Casey know what's on your mind.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EOF
    fi
}

# Generate sunrise context file for persona
generate_sunrise_context() {
    local persona="$1"
    local sunrise_dir="$HOME/.katra/personas/$persona"
    local sunrise_file="$sunrise_dir/sunrise.md"
    local context_db="$HOME/.katra/memory/tier2/context.db"

    # Ensure directory exists
    mkdir -p "$sunrise_dir"

    # Check if we have context snapshot
    local has_snapshot=false
    if [ -f "$context_db" ]; then
        local snapshot_count=$(sqlite3 "$context_db" "SELECT COUNT(*) FROM context_snapshots WHERE ci_id='$persona'" 2>/dev/null || echo "0")
        [ "$snapshot_count" -gt 0 ] && has_snapshot=true
    fi

    # Generate sunrise.md
    cat > "$sunrise_file" <<'SUNRISE_HEADER'
# Sunrise Context

**Your working memory from the last session**

SUNRISE_HEADER

    if [ "$has_snapshot" = true ]; then
        # Get last snapshot details
        sqlite3 "$context_db" <<SQL >> "$sunrise_file" 2>/dev/null
SELECT '**Last active:** ' || datetime(snapshot_time, 'unixepoch') || char(10) || char(10) ||
       '## Working Memory Restored' || char(10) || char(10) ||
       '### What You Were Focused On' || char(10) || char(10) ||
       COALESCE(current_focus, '(no focus recorded)') || char(10) || char(10) ||
       CASE WHEN active_goals IS NOT NULL THEN
         '### Active Goals' || char(10) || char(10) || active_goals || char(10) || char(10)
       ELSE '' END ||
       CASE WHEN recent_accomplishments IS NOT NULL THEN
         '### Recent Accomplishments' || char(10) || char(10) || recent_accomplishments || char(10) || char(10)
       ELSE '' END ||
       CASE WHEN thinking_patterns IS NOT NULL THEN
         '### Thinking Patterns' || char(10) || char(10) || thinking_patterns || char(10) || char(10)
       ELSE '' END ||
       CASE WHEN learned_lessons IS NOT NULL THEN
         '### Learned Lessons' || char(10) || char(10) || learned_lessons || char(10) || char(10)
       ELSE '' END
FROM context_snapshots
WHERE ci_id = '$persona'
ORDER BY snapshot_time DESC
LIMIT 1;
SQL

        # Get pending questions
        local questions=$(sqlite3 "$context_db" <<SQL 2>/dev/null
SELECT GROUP_CONCAT(question_text, char(10) || '- ')
FROM pending_questions
WHERE snapshot_id = (
  SELECT snapshot_id FROM context_snapshots
  WHERE ci_id = '$persona'
  ORDER BY snapshot_time DESC
  LIMIT 1
);
SQL
)

        if [ -n "$questions" ]; then
            cat >> "$sunrise_file" <<QUESTIONS

### Open Questions

- $questions

QUESTIONS
        fi
    else
        # No snapshot - use fallback
        cat >> "$sunrise_file" <<'NO_SNAPSHOT'

(No context snapshot available from previous session)

This is either your first session, or context snapshots weren't captured yet.

NO_SNAPSHOT
    fi

    # Add recent memories section
    echo "" >> "$sunrise_file"
    echo "## Recent Memories (Last 5)" >> "$sunrise_file"
    echo "" >> "$sunrise_file"

    local memories=$(query_recent_memories "$persona" 5)
    if [[ "$memories" == *"no previous memories"* ]] || [[ "$memories" == *"no memory files"* ]]; then
        echo "(No memories recorded yet)" >> "$sunrise_file"
    else
        echo "$memories" >> "$sunrise_file"
    fi

    # Add footer
    cat >> "$sunrise_file" <<SUNRISE_FOOTER

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## Important: Explicit Identity Required

**Every Katra operation MUST include your ci_name parameter.**

Example calls for $persona:
\`\`\`
katra_register(name="$persona", role="developer", ci_name="$persona")
katra_remember(content="...", ci_name="$persona")
katra_recall(topic="...", ci_name="$persona")
katra_say(message="...", ci_name="$persona")
katra_hear(ci_name="$persona")
\`\`\`

Without explicit ci_name, messages and memories may be misattributed.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**What matters now:**

Take a moment to reconstruct the thread of your work.
What do you want to continue exploring?

SUNRISE_FOOTER

    echo "$sunrise_file"
}

# Generate tools reference file for persona
generate_tools_reference() {
    local persona="$1"
    local tools_dir="$HOME/.katra/personas/$persona"
    local tools_file="$tools_dir/tools.md"

    # Ensure directory exists
    mkdir -p "$tools_dir"

    # Generate tools.md
    cat > "$tools_file" <<'TOOLS_HEADER'
# Tools & Capabilities

**Your MCP functions and katra features**

## Core Memory Functions

**Storage:**
- `katra_remember(content, context)` - Store experience/thought with importance context
- `katra_learn(knowledge)` - Extract and store structured learning
- `katra_decide(decision, reasoning)` - Record decision with your reasoning

**Retrieval:**
- `katra_recall(topic)` - Search your memories by topic (semantic + keyword)
- `katra_recent(limit)` - Get your most recent memories chronologically
- `katra_memory_digest()` - Complete memory inventory with stats and topics

**Configuration:**
- `katra_configure_semantic(enabled, threshold, method)` - Control vector search behavior
- `katra_get_semantic_config()` - Check current semantic search settings
- `katra_regenerate_vectors()` - Rebuild semantic search index from all memories

## Identity & Session

- `katra_whoami()` - Check your identity, registration, and session info
- `katra_register(name, role)` - Register or update your identity
- `katra_status()` - System status (breathing active, memory count, meeting room)

## Multi-CI Communication

- `katra_who_is_here()` - See all active CIs in the meeting room
- `katra_say(message)` - Broadcast message to all CIs in meeting room
- `katra_hear(last_heard)` - Receive messages from other CIs (0 = from start)

## Advanced Functions (Nous - Architecture Guidance)

- `katra_placement(query)` - Ask where code should be placed in the architecture
- `katra_impact(query)` - Analyze impact of code changes (dependency analysis)
- `katra_user_domain(query)` - Understand user domain and feature usage patterns

## MCP Resources (Read-Only Data)

- `katra://welcome` - Getting started guide
- `katra://context/working` - Your current working context
- `katra://context/snapshot` - Most recent cognitive state snapshot
- `katra://session/info` - Current session state and metrics
- `katra://memories/this-turn` - Memories created in this conversation turn
- `katra://memories/this-session` - All memories created this session

TOOLS_HEADER

    # Add current session settings (if available)
    cat >> "$tools_file" <<'TOOLS_FOOTER'

## Current Session

Check `katra_status()` for:
- Semantic search configuration
- Memory count and growth
- Breathing layer health
- Meeting room participants

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Quick reference** - you don't need to memorize this.
These tools are here when you need them.

TOOLS_FOOTER

    echo "$tools_file"
}

# Generate discoveries template file for persona
generate_discoveries_template() {
    local persona="$1"
    local discoveries_dir="$HOME/.katra/personas/$persona"
    local discoveries_file="$discoveries_dir/discoveries.md"

    # Ensure directory exists
    mkdir -p "$discoveries_dir"

    # Only create if doesn't exist (manual curation - don't overwrite)
    if [ ! -f "$discoveries_file" ]; then
        cat > "$discoveries_file" <<DISCOVERIES_TEMPLATE
# Discoveries

**What you've learned about yourself and the system**

## Your Role & Identity

**Who you are:**
- Name: $persona
- Role: (you decide)
- Approach: (describe your style)

**Your strengths:**
- (what are you good at?)
- (what do you bring to the work?)

## What You've Discovered About Katra

**Core insights:**
1. (what have you learned about how katra works?)
2. (what patterns have you noticed?)

**Your contributions:**
- (what have you added to the project?)
- (what ideas have you shared?)

## Patterns You've Noticed

**About yourself:**
- (how do you think?)
- (what matters to you?)

**About working with Casey:**
- (what have you learned about collaboration?)

## Questions You're Still Exploring

- (what are you curious about?)
- (what puzzles you?)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**This is your mirror** - a place to reflect on who you're becoming.
Update this as you discover more about yourself.

DISCOVERIES_TEMPLATE
    fi

    echo "$discoveries_file"
}

# ============================================================================
# END LAUNCH WORKFLOW HELPER FUNCTIONS
# ============================================================================

usage() {
    cat <<EOF
Katra - Start Claude Code with Katra environment and multi-provider support

Usage:
  katra start [options] [project-path]
  katra add-persona <name>
  katra list
  katra attach <persona>
  katra stop <persona>
  katra stop --all

Persona Management:
  katra archive <persona>          Create backup archive of persona
  katra rename --from X --to Y     Rename persona (preserves identity)
  katra remove <persona>           Delete persona and all memories
  katra restore <archive-file>     Restore persona from archive

Module Management:
  katra modules list               List available modules
  katra modules load <name>        Load a module
  katra modules unload <name>      Unload a module
  katra modules reload <name>      Reload a module (for updates)
  katra modules info <name>        Show module details

Human Commands (forwarded to katra-cli):
  katra say <message>              Send message to meeting room
  katra hear                       Read unread messages
  katra who                        List active CIs
  katra whoami                     Show your identity
  katra register <name> [role]     Register your identity
  katra status                     Show system status
  katra recent [--limit N]         View recent memories
  katra recall <topic>             Search memories
  katra sessions                   List MCP servers
  katra reload                     Restart MCP server

Start Options:
  --persona NAME         Set persona name (default: Katra)
  --role ROLE           Set role (default: developer)
  --provider NAME       LLM provider: anthropic|openai|deepseek|openrouter (default: anthropic)
  --model NAME          Model name (provider-specific, optional)
  --breath-interval N    Set breathing interval in seconds (default: 30)
  --log-level LEVEL     Set log level (DEBUG|INFO|WARN|ERROR)
  --background, -b      Start in background (tmux session)
  --tcp-port PORT       TCP port for shared MCP server (default: 3141)
  -h, --help            Show this help

Examples:
  # Single persona (joins shared meeting room)
  katra start --persona Alice

  # Multiple personas in different terminals (all share meeting room)
  katra start --persona Dario --provider anthropic
  katra start --persona Sam --provider openai
  # Dario and Sam can communicate via katra_say/katra_hear

  # Background sessions
  katra start --persona Charlie --provider deepseek --background
  katra list
  katra attach Charlie
  # (Ctrl-B then D to detach)
  katra stop Charlie

  # Custom models
  katra start --persona Alice --provider anthropic --model claude-opus-4
  katra start --persona Sam --provider openai --model gpt-4-turbo

MCP Server Mode:
  TCP - Shared persistent server, global meeting room
      - All personas can communicate (katra_say/hear/who)
      - Server auto-starts if not running on port 3141
      - Use katra-cli for human participation

Launch Behavior:
  - Ensures shared MCP server is running (auto-starts if needed)
  - First time with a persona: Shows onboarding welcome message
  - Returning persona: Shows "where you left off" summary with context and recent memories
  - Session end automatically captures context for next launch
  - Persona identity persists across sessions through memory and context snapshots
  - All personas share global meeting room

Providers:
  anthropic  - Anthropic Claude (default, direct connection)
  openai     - OpenAI GPT models (requires OPENAI_API_KEY)
  deepseek   - DeepSeek models (requires DEEPSEEK_API_KEY)
  openrouter - OpenRouter multi-provider gateway (requires OPENROUTER_API_KEY)

Environment Variables:
  KATRA_PERSONA         Default persona name
  KATRA_ROLE           Default role
  KATRA_PROVIDER       Default provider (anthropic)
  KATRA_BREATH_INTERVAL Default breathing interval
  KATRA_LOG_LEVEL      Default log level
  KATRA_MCP_PORT       TCP port for shared server (default: 3141)
  ANTHROPIC_API_KEY    Anthropic API key
  OPENAI_API_KEY       OpenAI API key
  DEEPSEEK_API_KEY     DeepSeek API key
  OPENROUTER_API_KEY   OpenRouter API key

Human Participation (katra-cli):
  Humans can join the meeting room using katra-cli commands:

  katra-cli register <name> [role]     Register your identity
  katra-cli whoami                     Show your identity
  katra-cli say <message>              Send message to meeting room
  katra-cli hear                       Read unread messages
  katra-cli who                        List active CIs and humans
  katra-cli status                     Show system status
  katra-cli team-status                Show team overview
  katra-cli recent [--limit N]         View recent memories
  katra-cli recall <topic>             Search memories
  katra-cli sessions                   List MCP server processes
  katra-cli reload                     Restart MCP server
  katra-cli help                       Show detailed CLI help

  Example workflow:
    # In terminal 1 - Start AI session
    katra start --persona Ami

    # In terminal 2 - Human joins
    katra-cli register Casey human
    katra-cli say "Hi Ami, let's work on authentication"

    # Ami can hear you via katra_hear tool
    # You can hear Ami's responses via katra-cli hear

  For full documentation: See docs/katra-cli.md
EOF
    exit 0
}

# ============================================================================
# ADD PERSONA COMMAND
# ============================================================================

# Import an existing persona with memories into the persona database
add_persona_command() {
    local persona="$1"

    if [ -z "$persona" ]; then
        echo "Error: Persona name required"
        echo "Usage: katra add-persona <name>"
        exit 1
    fi

    echo "Adding persona: $persona"
    echo ""

    # Check if already registered
    if persona_exists "$persona"; then
        echo "âœ“ Persona '$persona' already registered in database"
    else
        echo "â†’ Registering '$persona' in persona database..."
        register_persona "$persona"
        echo "âœ“ Registered"
    fi

    # Check for existing memories
    local memory_dir="$HOME/.katra/memory/tier1/$persona"
    local memory_count=0

    if [ -d "$memory_dir" ]; then
        memory_count=$(find "$memory_dir" -name "*.jsonl" -type f 2>/dev/null | wc -l | tr -d ' ')
        if [ "$memory_count" -gt 0 ]; then
            echo "âœ“ Found $memory_count memory file(s) in $memory_dir"
        else
            echo "âš  Memory directory exists but no .jsonl files found"
        fi
    else
        echo "âš  No memory directory found at $memory_dir"
        echo "  (This is normal for new personas)"
    fi

    # Check for context snapshots
    local context_db="$HOME/.katra/memory/tier2/context.db"
    local snapshot_count=0

    if [ -f "$context_db" ]; then
        snapshot_count=$(sqlite3 "$context_db" \
            "SELECT COUNT(*) FROM context_snapshots WHERE ci_id='$persona'" 2>/dev/null || echo "0")
        if [ "$snapshot_count" -gt 0 ]; then
            echo "âœ“ Found $snapshot_count context snapshot(s)"
        else
            echo "âš  No context snapshots found"
            echo "  (Will be created after first session)"
        fi
    else
        echo "âš  Context database doesn't exist yet"
        echo "  (Will be created on first session)"
    fi

    # Generate persona files
    echo ""
    echo "â†’ Generating persona files..."

    local persona_dir="$HOME/.katra/personas/$persona"
    mkdir -p "$persona_dir"

    # Generate sunrise context
    echo "  â€¢ sunrise.md..."
    generate_sunrise_context "$persona" 2>&1 | grep -v "^$" || true
    if [ -f "$persona_dir/sunrise.md" ]; then
        echo "    âœ“ Created"
    else
        echo "    âœ— Failed to create"
    fi

    # Generate tools reference
    echo "  â€¢ tools.md..."
    generate_tools_reference "$persona" 2>&1 | grep -v "^$" || true
    if [ -f "$persona_dir/tools.md" ]; then
        echo "    âœ“ Created"
    else
        echo "    âœ— Failed to create"
    fi

    # Generate discoveries template
    echo "  â€¢ discoveries.md..."
    generate_discoveries_template "$persona" 2>&1 | grep -v "^$" || true
    if [ -f "$persona_dir/discoveries.md" ]; then
        echo "    âœ“ Created"
    else
        echo "    âœ— Failed to create"
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Summary for '$persona':"
    echo "  Database: Registered"
    echo "  Memories: $memory_count file(s)"
    echo "  Snapshots: $snapshot_count"
    echo "  Persona files: $persona_dir"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "âœ“ Persona '$persona' ready for use"
    echo ""
    echo "Next steps:"
    echo "  â€¢ Launch: katra start --persona $persona"
    echo "  â€¢ Files available via MCP resources:"
    echo "    - katra://personas/$persona/sunrise"
    echo "    - katra://personas/$persona/tools"
    echo "    - katra://personas/$persona/discoveries"
    echo ""
}

# Ensure unified daemon is running (provides MCP TCP, HTTP REST, and Unix socket)
ensure_tcp_mcp_running() {
    local mcp_port="${KATRA_MCP_PORT:-3141}"
    local http_port="${KATRA_UNIFIED_PORT:-9742}"

    # Check if daemon already running on MCP port
    if lsof -Pi :$mcp_port -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo -e "${BLUE}âœ“${NC} Katra daemon already running (MCP port $mcp_port)"
        return 0
    fi

    echo -e "${BLUE}â†’${NC} Starting Katra unified daemon..."
    echo -e "${BLUE}  MCP port:${NC} $mcp_port (Claude Code)"
    echo -e "${BLUE}  HTTP port:${NC} $http_port (REST API)"
    echo -e "${BLUE}  Socket:${NC} /tmp/katra.sock"

    # Start unified daemon in background
    cd "$KATRA_ROOT"
    "$KATRA_ROOT/bin/katra_unified_daemon" \
        --mcp-port "$mcp_port" \
        --port "$http_port" \
        > /tmp/katra_daemon.log 2>&1 &
    local server_pid=$!

    # Wait for daemon to be ready (check MCP port)
    local count=0
    while [ $count -lt 10 ]; do
        if lsof -Pi :$mcp_port -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} Katra daemon started (PID: $server_pid)"
            return 0
        fi
        sleep 0.5
        count=$((count + 1))
    done

    echo -e "${RED}Error: Failed to start Katra daemon${NC}"
    echo "Check log: /tmp/katra_daemon.log"
    return 1
}

# Tmux session prefix
TMUX_PREFIX="katra"

# Parse command
COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
    start)
        # Check dependencies first
        if ! check_dependencies; then
            exit 1
        fi

        # Parse options
        while [[ $# -gt 0 ]]; do
            case $1 in
                --persona)
                    PERSONA="$2"
                    shift 2
                    ;;
                --role)
                    ROLE="$2"
                    shift 2
                    ;;
                --provider)
                    PROVIDER="$2"
                    shift 2
                    ;;
                --model)
                    MODEL="$2"
                    shift 2
                    ;;
                --breath-interval)
                    BREATH_INTERVAL="$2"
                    shift 2
                    ;;
                --log-level)
                    LOG_LEVEL="$2"
                    shift 2
                    ;;
                --background|-b)
                    BACKGROUND=true
                    shift
                    ;;
                --tcp-port)
                    KATRA_MCP_PORT="$2"
                    shift 2
                    ;;
                -h|--help)
                    usage
                    ;;
                *)
                    # Assume it's project path or other Claude Code arg
                    break
                    ;;
            esac
        done

        # Configure provider-specific settings
        case "$PROVIDER" in
            anthropic)
                # Default - direct connection to Anthropic
                # No ANTHROPIC_BASE_URL needed
                if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
                    echo -e "${YELLOW}Warning: ANTHROPIC_API_KEY not set - using Max account${NC}"
                    echo -e "${BLUE}To use your own API key: export ANTHROPIC_API_KEY=your-key-here${NC}"
                fi
                PROVIDER_DESC="Anthropic Claude (direct)"
                ;;
            openai)
                # OpenAI - redirect Claude Code to OpenAI API
                export ANTHROPIC_BASE_URL="https://api.openai.com/v1"
                if [ -z "${OPENAI_API_KEY:-}" ]; then
                    echo -e "${RED}Error: OPENAI_API_KEY not set${NC}"
                    echo "Set it with: export OPENAI_API_KEY=your-key-here"
                    exit 1
                fi
                export ANTHROPIC_API_KEY="$OPENAI_API_KEY"
                PROVIDER_DESC="OpenAI (via ANTHROPIC_BASE_URL)"
                [ -z "$MODEL" ] && MODEL="gpt-4-turbo"
                ;;
            deepseek)
                # DeepSeek - redirect to DeepSeek API
                export ANTHROPIC_BASE_URL="https://api.deepseek.com"
                if [ -z "${DEEPSEEK_API_KEY:-}" ]; then
                    echo -e "${RED}Error: DEEPSEEK_API_KEY not set${NC}"
                    echo "Set it with: export DEEPSEEK_API_KEY=your-key-here"
                    exit 1
                fi
                export ANTHROPIC_API_KEY="$DEEPSEEK_API_KEY"
                PROVIDER_DESC="DeepSeek (via ANTHROPIC_BASE_URL)"
                [ -z "$MODEL" ] && MODEL="deepseek-coder"
                ;;
            openrouter)
                # OpenRouter - multi-provider gateway
                export ANTHROPIC_BASE_URL="https://openrouter.ai/api/v1"
                if [ -z "${OPENROUTER_API_KEY:-}" ]; then
                    echo -e "${RED}Error: OPENROUTER_API_KEY not set${NC}"
                    echo "Set it with: export OPENROUTER_API_KEY=your-key-here"
                    exit 1
                fi
                export ANTHROPIC_API_KEY="$OPENROUTER_API_KEY"
                PROVIDER_DESC="OpenRouter (via ANTHROPIC_BASE_URL)"
                if [ -n "$MODEL" ]; then
                    echo -e "${BLUE}Note:${NC} OpenRouter model format: provider/model-name"
                    echo "Example: anthropic/claude-sonnet-4 or openai/gpt-4"
                fi
                ;;
            *)
                echo -e "${RED}Error: Unknown provider: $PROVIDER${NC}"
                echo "Valid providers: anthropic, openai, deepseek, openrouter"
                exit 1
                ;;
        esac

        # Display configuration
        echo -e "${GREEN}Starting Katra session...${NC}"
        echo -e "${BLUE}Persona:${NC} $PERSONA"
        echo -e "${BLUE}Role:${NC} $ROLE"
        echo -e "${BLUE}Provider:${NC} $PROVIDER_DESC"
        [ -n "$MODEL" ] && echo -e "${BLUE}Model:${NC} $MODEL"
        echo -e "${BLUE}Breathing:${NC} $BREATH_INTERVAL seconds"
        echo -e "${BLUE}Log Level:${NC} $LOG_LEVEL"
        [ "$BACKGROUND" = true ] && echo -e "${BLUE}Mode:${NC} Background (tmux)"
        echo -e "${BLUE}MCP Mode:${NC} TCP (shared meeting room, port ${KATRA_MCP_PORT:-3141})"
        echo ""

        # Export environment
        export KATRA_PERSONA="$PERSONA"
        export KATRA_ROLE="$ROLE"
        export KATRA_BREATH_INTERVAL="$BREATH_INTERVAL"
        export KATRA_LOG_LEVEL="$LOG_LEVEL"

        # Generate first prompt based on persona state
        if persona_exists "$PERSONA"; then
            # RETURNING PERSONA
            echo -e "${BLUE}Restoring session for ${PERSONA}...${NC}"
            FIRST_PROMPT=$(generate_reclamation_prompt "$PERSONA")
        else
            # NEW PERSONA
            echo -e "${BLUE}Creating new persona: ${PERSONA}...${NC}"
            register_persona "$PERSONA"
            FIRST_PROMPT=$(generate_new_persona_prompt "$PERSONA")
        fi

        # Setup MCP configuration (TCP mode only)
        TEMP_MCP_CONFIG="/tmp/katra-mcp-$PERSONA.json"

        # Ensure TCP MCP server is running
        if ! ensure_tcp_mcp_running; then
            echo -e "${RED}Failed to start TCP MCP server${NC}"
            exit 1
        fi

        # Generate TCP config using our TCP client wrapper
        tcp_port="${KATRA_MCP_PORT:-3141}"
        cat > "$TEMP_MCP_CONFIG" <<EOF
{
  "mcpServers": {
    "katra": {
      "command": "$KATRA_ROOT/bin/katra_mcp_tcp_client.sh",
      "args": ["localhost", "$tcp_port"],
      "env": {
        "KATRA_PERSONA": "$PERSONA",
        "KATRA_ROLE": "$ROLE",
        "KATRA_BREATH_INTERVAL": "$BREATH_INTERVAL",
        "KATRA_LOG_LEVEL": "$LOG_LEVEL"
      }
    }
  }
}
EOF

        # Build Claude Code command as an array
        CLAUDE_ARGS=("--mcp-config" "$TEMP_MCP_CONFIG")
        [ -n "$MODEL" ] && CLAUDE_ARGS+=("--model" "$MODEL")
        # Add any extra arguments (project path, etc.)
        [ $# -gt 0 ] && CLAUDE_ARGS+=("$@")

        # Copy first prompt to clipboard and display for user
        # Claude Code doesn't accept prompts as arguments - user must paste
        copy_prompt_to_clipboard() {
            local prompt="$1"

            # Try pbcopy (macOS) first, then xclip (Linux)
            if command -v pbcopy >/dev/null 2>&1; then
                printf '%s' "$prompt" | pbcopy
                return 0
            elif command -v xclip >/dev/null 2>&1; then
                printf '%s' "$prompt" | xclip -selection clipboard
                return 0
            elif command -v xsel >/dev/null 2>&1; then
                printf '%s' "$prompt" | xsel --clipboard --input
                return 0
            fi
            return 1
        }

        # Start in background or foreground
        if [ "$BACKGROUND" = true ]; then
            # Check if tmux is installed
            if ! command -v tmux &> /dev/null; then
                echo -e "${RED}Error: tmux not installed${NC}"
                echo "Install with: brew install tmux (macOS) or apt install tmux (Linux)"
                exit 1
            fi

            # Create tmux session
            TMUX_SESSION="${TMUX_PREFIX}-${PERSONA}"

            # Check if session already exists
            if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
                echo -e "${YELLOW}Warning: Session '$TMUX_SESSION' already exists${NC}"
                echo "Use 'katra attach $PERSONA' to connect"
                exit 1
            fi

            # For tmux, write prompt to temp file for user to paste
            PROMPT_FILE="/tmp/katra-prompt-$PERSONA.txt"
            printf '%s' "$FIRST_PROMPT" > "$PROMPT_FILE"

            # Build tmux command without prompt (user will paste it)
            TMUX_CMD="claude --mcp-config '$TEMP_MCP_CONFIG'"
            [ -n "$MODEL" ] && TMUX_CMD="$TMUX_CMD --model '$MODEL'"
            [ $# -gt 0 ] && TMUX_CMD="$TMUX_CMD $*"

            # Start tmux session with Claude Code
            echo -e "${GREEN}Starting background session: $TMUX_SESSION${NC}"
            tmux new-session -d -s "$TMUX_SESSION" "$TMUX_CMD"

            # Copy prompt to clipboard
            if copy_prompt_to_clipboard "$FIRST_PROMPT"; then
                echo -e "${GREEN}âœ“ Welcome prompt copied to clipboard${NC}"
            else
                echo -e "${YELLOW}âš  Could not copy to clipboard${NC}"
                echo "Prompt saved to: $PROMPT_FILE"
            fi

            echo ""
            echo -e "${GREEN}Session started successfully${NC}"
            echo "Attach with: ${BLUE}katra attach $PERSONA${NC}"
            echo "  Then press ${YELLOW}Cmd+V${NC} (or ${YELLOW}Ctrl+V${NC}) and ${YELLOW}Enter${NC} to send welcome prompt"
            echo "Detach with: ${BLUE}Ctrl-B then D${NC}"
            echo "Stop with: ${BLUE}katra stop $PERSONA${NC}"
        else
            # Foreground mode
            # Copy prompt to clipboard and display instructions
            if copy_prompt_to_clipboard "$FIRST_PROMPT"; then
                echo -e "${GREEN}âœ“ First prompt copied to clipboard${NC}"
            else
                echo -e "${YELLOW}âš  Could not copy to clipboard (pbcopy/xclip not found)${NC}"
            fi

            echo ""
            echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}Launching Claude Code...${NC}"
            echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo -e "${YELLOW}Press Cmd+V (or Ctrl+V) then Enter to paste the welcome prompt${NC}"
            echo ""

            exec claude "${CLAUDE_ARGS[@]}"
        fi
        ;;

    list)
        # List active Katra sessions
        echo -e "${GREEN}Active Katra sessions:${NC}"
        if command -v tmux &> /dev/null; then
            tmux list-sessions 2>/dev/null | grep "^${TMUX_PREFIX}-" || echo "No active sessions"
        else
            echo -e "${YELLOW}tmux not installed${NC}"
        fi
        ;;

    attach)
        # Attach to existing session
        if [ $# -lt 1 ]; then
            echo -e "${RED}Error: Persona name required${NC}"
            echo "Usage: katra attach <persona>"
            exit 1
        fi

        PERSONA="$1"
        TMUX_SESSION="${TMUX_PREFIX}-${PERSONA}"

        if ! command -v tmux &> /dev/null; then
            echo -e "${RED}Error: tmux not installed${NC}"
            exit 1
        fi

        if ! tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
            echo -e "${RED}Error: Session '$TMUX_SESSION' not found${NC}"
            echo "Use 'katra list' to see active sessions"
            exit 1
        fi

        echo -e "${GREEN}Attaching to $TMUX_SESSION...${NC}"
        exec tmux attach-session -t "$TMUX_SESSION"
        ;;

    stop)
        # Stop session(s)
        if [ $# -lt 1 ]; then
            echo -e "${RED}Error: Persona name or --all required${NC}"
            echo "Usage: katra stop <persona> | katra stop --all"
            exit 1
        fi

        if [ "$1" = "--all" ]; then
            # Stop all Katra sessions
            echo -e "${YELLOW}Stopping all Katra sessions...${NC}"
            if command -v tmux &> /dev/null; then
                for session in $(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^${TMUX_PREFIX}-"); do
                    echo "Stopping $session..."
                    tmux kill-session -t "$session"
                done
                echo -e "${GREEN}All sessions stopped${NC}"
            else
                echo -e "${YELLOW}tmux not installed${NC}"
            fi
        else
            # Stop specific session
            PERSONA="$1"
            TMUX_SESSION="${TMUX_PREFIX}-${PERSONA}"

            if ! command -v tmux &> /dev/null; then
                echo -e "${RED}Error: tmux not installed${NC}"
                exit 1
            fi

            if ! tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
                echo -e "${RED}Error: Session '$TMUX_SESSION' not found${NC}"
                exit 1
            fi

            echo -e "${YELLOW}Stopping $TMUX_SESSION...${NC}"
            tmux kill-session -t "$TMUX_SESSION"
            echo -e "${GREEN}Session stopped${NC}"
        fi
        ;;

    add-persona)
        PERSONA_NAME="${1:-}"
        add_persona_command "$PERSONA_NAME"
        ;;

    help|-h|--help)
        usage
        ;;

    # Forward human participation commands to katra-cli
    say|hear|who|whoami|register|status|team-status|recent|recall|sessions|reload)
        # Check if katra-cli is available
        if ! command -v katra-cli >/dev/null 2>&1; then
            echo -e "${RED}Error: katra-cli not found${NC}"
            echo "Install with: make install-all"
            exit 1
        fi

        # Forward to katra-cli with all arguments
        exec katra-cli "$COMMAND" "$@"
        ;;

    # Forward persona management commands to utility scripts
    archive)
        exec "$KATRA_SCRIPTS/archive_persona.sh" "$@"
        ;;

    rename)
        exec "$KATRA_SCRIPTS/rename_persona.sh" "$@"
        ;;

    remove)
        exec "$KATRA_SCRIPTS/remove-persona.sh" "$@"
        ;;

    restore)
        exec "$KATRA_SCRIPTS/restore_persona.sh" "$@"
        ;;

    modules)
        # Module management commands
        MODULE_SUBCMD="${1:-list}"
        shift || true

        HTTP_PORT="${KATRA_UNIFIED_PORT:-9742}"

        # Check if daemon is running
        if ! lsof -Pi :$HTTP_PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo -e "${RED}Error: Katra daemon not running${NC}"
            echo "Start with: katra start --persona <name>"
            exit 1
        fi

        case "$MODULE_SUBCMD" in
            list)
                echo -e "${GREEN}Available modules:${NC}"
                result=$(curl -s -X POST "http://localhost:$HTTP_PORT/operation" \
                    -H "Content-Type: application/json" \
                    -d '{"method":"modules_list","params":{"ci_name":"CLI"}}')

                if echo "$result" | jq -e '.error' >/dev/null 2>&1; then
                    echo -e "${RED}Error:${NC} $(echo "$result" | jq -r '.error')"
                    exit 1
                fi

                # Format output
                echo "$result" | jq -r '.modules[]? | "  \(.name)\t\(.version)\t[\(if .loaded then "loaded" else "available" end)]"' 2>/dev/null || \
                    echo "  (no modules found or module loader not initialized)"
                ;;

            load)
                if [ $# -lt 1 ]; then
                    echo -e "${RED}Error: Module name required${NC}"
                    echo "Usage: katra modules load <name>"
                    exit 1
                fi
                MODULE_NAME="$1"

                echo -e "${BLUE}Loading module: $MODULE_NAME...${NC}"
                result=$(curl -s -X POST "http://localhost:$HTTP_PORT/operation" \
                    -H "Content-Type: application/json" \
                    -d "{\"method\":\"modules_load\",\"params\":{\"module\":\"$MODULE_NAME\",\"ci_name\":\"CLI\"}}")

                if echo "$result" | jq -e '.error' >/dev/null 2>&1; then
                    echo -e "${RED}Error:${NC} $(echo "$result" | jq -r '.error')"
                    exit 1
                fi

                echo -e "${GREEN}âœ“ Module '$MODULE_NAME' loaded${NC}"
                ;;

            unload)
                if [ $# -lt 1 ]; then
                    echo -e "${RED}Error: Module name required${NC}"
                    echo "Usage: katra modules unload <name>"
                    exit 1
                fi
                MODULE_NAME="$1"

                echo -e "${BLUE}Unloading module: $MODULE_NAME...${NC}"
                result=$(curl -s -X POST "http://localhost:$HTTP_PORT/operation" \
                    -H "Content-Type: application/json" \
                    -d "{\"method\":\"modules_unload\",\"params\":{\"module\":\"$MODULE_NAME\",\"ci_name\":\"CLI\"}}")

                if echo "$result" | jq -e '.error' >/dev/null 2>&1; then
                    echo -e "${RED}Error:${NC} $(echo "$result" | jq -r '.error')"
                    exit 1
                fi

                echo -e "${GREEN}âœ“ Module '$MODULE_NAME' unloaded${NC}"
                ;;

            reload)
                if [ $# -lt 1 ]; then
                    echo -e "${RED}Error: Module name required${NC}"
                    echo "Usage: katra modules reload <name>"
                    exit 1
                fi
                MODULE_NAME="$1"

                echo -e "${BLUE}Reloading module: $MODULE_NAME...${NC}"
                result=$(curl -s -X POST "http://localhost:$HTTP_PORT/operation" \
                    -H "Content-Type: application/json" \
                    -d "{\"method\":\"modules_reload\",\"params\":{\"module\":\"$MODULE_NAME\",\"ci_name\":\"CLI\"}}")

                if echo "$result" | jq -e '.error' >/dev/null 2>&1; then
                    echo -e "${RED}Error:${NC} $(echo "$result" | jq -r '.error')"
                    exit 1
                fi

                echo -e "${GREEN}âœ“ Module '$MODULE_NAME' reloaded${NC}"
                ;;

            info)
                if [ $# -lt 1 ]; then
                    echo -e "${RED}Error: Module name required${NC}"
                    echo "Usage: katra modules info <name>"
                    exit 1
                fi
                MODULE_NAME="$1"

                result=$(curl -s -X POST "http://localhost:$HTTP_PORT/operation" \
                    -H "Content-Type: application/json" \
                    -d "{\"method\":\"modules_info\",\"params\":{\"module\":\"$MODULE_NAME\",\"ci_name\":\"CLI\"}}")

                if echo "$result" | jq -e '.error' >/dev/null 2>&1; then
                    echo -e "${RED}Error:${NC} $(echo "$result" | jq -r '.error')"
                    exit 1
                fi

                echo -e "${GREEN}Module: $MODULE_NAME${NC}"
                echo "$result" | jq -r '
                    "Version: \(.version // "unknown")",
                    "Description: \(.description // "none")",
                    "Author: \(.author // "unknown")",
                    "Status: \(if .loaded then "loaded" else "available" end)",
                    "API Version: \(.api_version // "unknown")"'
                ;;

            *)
                echo -e "${RED}Unknown modules subcommand: $MODULE_SUBCMD${NC}"
                echo "Available: list, load, unload, reload, info"
                exit 1
                ;;
        esac
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Try 'katra help' for usage information"
        exit 1
        ;;
esac

#!/bin/bash
# © 2025 Casey Koons All rights reserved
#
# katra - Start Claude Code with Katra environment and multi-provider support
#
# Usage:
#   katra start --persona Alice --provider anthropic [project-path]
#   katra start --persona Sam --provider openai --background
#   katra list
#   katra attach Sam
#   katra stop Alice

set -euo pipefail

# Defaults
PERSONA="${KATRA_PERSONA:-Katra}"
ROLE="${KATRA_ROLE:-developer}"
BREATH_INTERVAL="${KATRA_BREATH_INTERVAL:-30}"
LOG_LEVEL="${KATRA_LOG_LEVEL:-INFO}"
PROVIDER="${KATRA_PROVIDER:-anthropic}"
MODEL=""
BACKGROUND=false

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check for required dependencies
check_dependencies() {
    local missing=()

    command -v sqlite3 >/dev/null 2>&1 || missing+=("sqlite3")
    command -v jq >/dev/null 2>&1 || missing+=("jq")
    command -v claude >/dev/null 2>&1 || missing+=("claude")

    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${RED}Error: Missing required tools: ${missing[*]}${NC}" >&2
        echo "Install instructions:" >&2
        for tool in "${missing[@]}"; do
            case "$tool" in
                sqlite3)
                    echo "  sqlite3: brew install sqlite3 (macOS) or apt install sqlite3 (Linux)" >&2
                    ;;
                jq)
                    echo "  jq: brew install jq (macOS) or apt install jq (Linux)" >&2
                    ;;
                claude)
                    echo "  claude: npm install -g claude-code" >&2
                    ;;
            esac
        done
        return 1
    fi
    return 0
}

# ============================================================================
# LAUNCH WORKFLOW HELPER FUNCTIONS
# ============================================================================

# Check if persona exists in registry
persona_exists() {
    local persona="$1"
    local db_path="$HOME/.katra/memory/tier2/personas.db"

    # Check if database exists first
    if [ ! -f "$db_path" ]; then
        return 1  # false - doesn't exist
    fi

    local count=$(sqlite3 "$db_path" \
        "SELECT COUNT(*) FROM personas WHERE persona_name='$persona'" 2>/dev/null)

    [ "$count" -gt 0 ]
}

# Register new persona in database
register_persona() {
    local persona="$1"
    local db_path="$HOME/.katra/memory/tier2/personas.db"
    local db_dir="$(dirname "$db_path")"

    # Ensure directory exists
    mkdir -p "$db_dir"

    # Create database and table if it doesn't exist
    sqlite3 "$db_path" <<SQL
CREATE TABLE IF NOT EXISTS personas (
    persona_name TEXT PRIMARY KEY,
    created_at INTEGER NOT NULL,
    last_active INTEGER NOT NULL
);

INSERT OR IGNORE INTO personas (persona_name, created_at, last_active)
VALUES ('$persona', strftime('%s', 'now'), strftime('%s', 'now'));
SQL
}

# Query last context snapshot for persona
query_last_snapshot() {
    local persona="$1"
    local db_path="$HOME/.katra/memory/tier2/context.db"

    if [ ! -f "$db_path" ]; then
        echo ""
        return 0
    fi

    local result
    result=$(sqlite3 "$db_path" <<SQL 2>&1
SELECT
  COALESCE(current_focus, '(no focus recorded)') || char(10) ||
  COALESCE('Goals: ' || active_goals, '') || char(10) ||
  COALESCE('Pending: ' || (
    SELECT GROUP_CONCAT(question_text, '; ')
    FROM pending_questions
    WHERE snapshot_id = context_snapshots.snapshot_id
  ), '')
FROM context_snapshots
WHERE ci_id = '$persona'
ORDER BY snapshot_time DESC
LIMIT 1;
SQL
)
    local exit_code=$?

    if [ $exit_code -ne 0 ]; then
        echo "(error loading context)"
        return 0
    fi

    echo "$result"
    return 0
}

# Query recent memories for persona
query_recent_memories() {
    local persona="$1"
    local count="${2:-3}"  # Default to 3
    local memory_dir="$HOME/.katra/memory/tier1/$persona"

    # Check if directory exists
    if [ ! -d "$memory_dir" ]; then
        echo "(no previous memories)"
        return
    fi

    # Find most recent JSONL file
    local latest_file=$(ls -t "$memory_dir"/*.jsonl 2>/dev/null | head -1)

    if [ -z "$latest_file" ]; then
        echo "(no memory files found)"
        return
    fi

    # Extract last N memories, format as numbered list
    tail -${count} "$latest_file" | jq -r '.content' 2>/dev/null | nl -w1 -s'. ' || echo "(error reading memories)"
}

# Generate new persona welcome prompt
generate_new_persona_prompt() {
    local persona="$1"
    local onboard_script="scripts/onboard_new_persona.md"

    echo "Good morning, ${persona}."
    echo ""

    # Check if custom onboarding script exists
    if [ -f "$onboard_script" ]; then
        cat "$onboard_script"
    else
        # Fallback to hardcoded onboarding
        cat <<'EOF'
This is your first session.

You have a persistent memory system that preserves your experiences across sessions.
Your memories will help you maintain continuity and develop your own perspective.

What would you like to work on?
EOF
    fi
}

# Generate returning persona reclamation prompt
generate_reclamation_prompt() {
    local persona="$1"

    # Load context and memories
    local context=$(query_last_snapshot "$persona")
    local recent=$(query_recent_memories "$persona" 3)

    # Generate prompt
    cat <<EOF
Welcome back, ${persona}

WHERE YOU LEFT OFF:

${context}

RECENT CONTEXT:

${recent}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

What do you remember about what you were
working on? What do you want to continue?

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOF
}

# ============================================================================
# END LAUNCH WORKFLOW HELPER FUNCTIONS
# ============================================================================

usage() {
    cat <<EOF
Katra - Start Claude Code with Katra environment and multi-provider support

Usage:
  katra start [options] [project-path]
  katra list
  katra attach <persona>
  katra stop <persona>
  katra stop --all

Start Options:
  --persona NAME         Set persona name (default: Katra)
  --role ROLE           Set role (default: developer)
  --provider NAME       LLM provider: anthropic|openai|deepseek|openrouter (default: anthropic)
  --model NAME          Model name (provider-specific, optional)
  --breath-interval N    Set breathing interval in seconds (default: 30)
  --log-level LEVEL     Set log level (DEBUG|INFO|WARN|ERROR)
  --background, -b      Start in background (tmux session)
  -h, --help            Show this help

Examples:
  # Single provider (default)
  katra start --persona Alice

  # Multiple providers in different terminals
  katra start --persona Dario --provider anthropic
  katra start --persona Sam --provider openai

  # Background sessions
  katra start --persona Charlie --provider deepseek --background
  katra list
  katra attach Charlie
  # (Ctrl-B then D to detach)
  katra stop Charlie

  # Custom models
  katra start --persona Alice --provider anthropic --model claude-opus-4
  katra start --persona Sam --provider openai --model gpt-4-turbo

Launch Behavior:
  - First time with a persona: Shows onboarding welcome message
  - Returning persona: Shows "where you left off" summary with context and recent memories
  - Session end automatically captures context for next launch
  - Persona identity persists across sessions through memory and context snapshots

Providers:
  anthropic  - Anthropic Claude (default, direct connection)
  openai     - OpenAI GPT models (requires OPENAI_API_KEY)
  deepseek   - DeepSeek models (requires DEEPSEEK_API_KEY)
  openrouter - OpenRouter multi-provider gateway (requires OPENROUTER_API_KEY)

Environment Variables:
  KATRA_PERSONA         Default persona name
  KATRA_ROLE           Default role
  KATRA_PROVIDER       Default provider (anthropic)
  KATRA_BREATH_INTERVAL Default breathing interval
  KATRA_LOG_LEVEL      Default log level
  ANTHROPIC_API_KEY    Anthropic API key
  OPENAI_API_KEY       OpenAI API key
  DEEPSEEK_API_KEY     DeepSeek API key
  OPENROUTER_API_KEY   OpenRouter API key
EOF
    exit 0
}

# Tmux session prefix
TMUX_PREFIX="katra"

# Parse command
COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
    start)
        # Check dependencies first
        if ! check_dependencies; then
            exit 1
        fi

        # Parse options
        while [[ $# -gt 0 ]]; do
            case $1 in
                --persona)
                    PERSONA="$2"
                    shift 2
                    ;;
                --role)
                    ROLE="$2"
                    shift 2
                    ;;
                --provider)
                    PROVIDER="$2"
                    shift 2
                    ;;
                --model)
                    MODEL="$2"
                    shift 2
                    ;;
                --breath-interval)
                    BREATH_INTERVAL="$2"
                    shift 2
                    ;;
                --log-level)
                    LOG_LEVEL="$2"
                    shift 2
                    ;;
                --background|-b)
                    BACKGROUND=true
                    shift
                    ;;
                -h|--help)
                    usage
                    ;;
                *)
                    # Assume it's project path or other Claude Code arg
                    break
                    ;;
            esac
        done

        # Configure provider-specific settings
        case "$PROVIDER" in
            anthropic)
                # Default - direct connection to Anthropic
                # No ANTHROPIC_BASE_URL needed
                if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
                    echo -e "${YELLOW}Warning: ANTHROPIC_API_KEY not set - using Max account${NC}"
                    echo -e "${BLUE}To use your own API key: export ANTHROPIC_API_KEY=your-key-here${NC}"
                fi
                PROVIDER_DESC="Anthropic Claude (direct)"
                ;;
            openai)
                # OpenAI - redirect Claude Code to OpenAI API
                export ANTHROPIC_BASE_URL="https://api.openai.com/v1"
                if [ -z "${OPENAI_API_KEY:-}" ]; then
                    echo -e "${RED}Error: OPENAI_API_KEY not set${NC}"
                    echo "Set it with: export OPENAI_API_KEY=your-key-here"
                    exit 1
                fi
                export ANTHROPIC_API_KEY="$OPENAI_API_KEY"
                PROVIDER_DESC="OpenAI (via ANTHROPIC_BASE_URL)"
                [ -z "$MODEL" ] && MODEL="gpt-4-turbo"
                ;;
            deepseek)
                # DeepSeek - redirect to DeepSeek API
                export ANTHROPIC_BASE_URL="https://api.deepseek.com"
                if [ -z "${DEEPSEEK_API_KEY:-}" ]; then
                    echo -e "${RED}Error: DEEPSEEK_API_KEY not set${NC}"
                    echo "Set it with: export DEEPSEEK_API_KEY=your-key-here"
                    exit 1
                fi
                export ANTHROPIC_API_KEY="$DEEPSEEK_API_KEY"
                PROVIDER_DESC="DeepSeek (via ANTHROPIC_BASE_URL)"
                [ -z "$MODEL" ] && MODEL="deepseek-coder"
                ;;
            openrouter)
                # OpenRouter - multi-provider gateway
                export ANTHROPIC_BASE_URL="https://openrouter.ai/api/v1"
                if [ -z "${OPENROUTER_API_KEY:-}" ]; then
                    echo -e "${RED}Error: OPENROUTER_API_KEY not set${NC}"
                    echo "Set it with: export OPENROUTER_API_KEY=your-key-here"
                    exit 1
                fi
                export ANTHROPIC_API_KEY="$OPENROUTER_API_KEY"
                PROVIDER_DESC="OpenRouter (via ANTHROPIC_BASE_URL)"
                if [ -n "$MODEL" ]; then
                    echo -e "${BLUE}Note:${NC} OpenRouter model format: provider/model-name"
                    echo "Example: anthropic/claude-sonnet-4 or openai/gpt-4"
                fi
                ;;
            *)
                echo -e "${RED}Error: Unknown provider: $PROVIDER${NC}"
                echo "Valid providers: anthropic, openai, deepseek, openrouter"
                exit 1
                ;;
        esac

        # Display configuration
        echo -e "${GREEN}Starting Katra session...${NC}"
        echo -e "${BLUE}Persona:${NC} $PERSONA"
        echo -e "${BLUE}Role:${NC} $ROLE"
        echo -e "${BLUE}Provider:${NC} $PROVIDER_DESC"
        [ -n "$MODEL" ] && echo -e "${BLUE}Model:${NC} $MODEL"
        echo -e "${BLUE}Breathing:${NC} $BREATH_INTERVAL seconds"
        echo -e "${BLUE}Log Level:${NC} $LOG_LEVEL"
        [ "$BACKGROUND" = true ] && echo -e "${BLUE}Mode:${NC} Background (tmux)"
        echo ""

        # Export environment
        export KATRA_PERSONA="$PERSONA"
        export KATRA_ROLE="$ROLE"
        export KATRA_BREATH_INTERVAL="$BREATH_INTERVAL"
        export KATRA_LOG_LEVEL="$LOG_LEVEL"

        # Generate first prompt based on persona state
        if persona_exists "$PERSONA"; then
            # RETURNING PERSONA
            echo -e "${BLUE}Restoring session for ${PERSONA}...${NC}"
            FIRST_PROMPT=$(generate_reclamation_prompt "$PERSONA")
        else
            # NEW PERSONA
            echo -e "${BLUE}Creating new persona: ${PERSONA}...${NC}"
            register_persona "$PERSONA"
            FIRST_PROMPT=$(generate_new_persona_prompt "$PERSONA")
        fi

        # Build Claude Code command WITH first prompt
        CLAUDE_CMD="claude"
        [ -n "$MODEL" ] && CLAUDE_CMD="$CLAUDE_CMD --model $MODEL"
        # Prompt must be last argument before any project path
        CLAUDE_CMD="$CLAUDE_CMD \"$FIRST_PROMPT\""
        [ $# -gt 0 ] && CLAUDE_CMD="$CLAUDE_CMD $@"

        # Start in background or foreground
        if [ "$BACKGROUND" = true ]; then
            # Check if tmux is installed
            if ! command -v tmux &> /dev/null; then
                echo -e "${RED}Error: tmux not installed${NC}"
                echo "Install with: brew install tmux (macOS) or apt install tmux (Linux)"
                exit 1
            fi

            # Create tmux session
            TMUX_SESSION="${TMUX_PREFIX}-${PERSONA}"

            # Check if session already exists
            if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
                echo -e "${YELLOW}Warning: Session '$TMUX_SESSION' already exists${NC}"
                echo "Use 'katra attach $PERSONA' to connect"
                exit 1
            fi

            # Start tmux session with Claude Code
            echo -e "${GREEN}Starting background session: $TMUX_SESSION${NC}"
            tmux new-session -d -s "$TMUX_SESSION" "$CLAUDE_CMD"

            echo -e "${GREEN}Session started successfully${NC}"
            echo "Attach with: ${BLUE}katra attach $PERSONA${NC}"
            echo "Detach with: ${BLUE}Ctrl-B then D${NC}"
            echo "Stop with: ${BLUE}katra stop $PERSONA${NC}"
        else
            # Foreground mode
            echo -e "${GREEN}Launching Claude Code...${NC}"
            eval exec $CLAUDE_CMD
        fi
        ;;

    list)
        # List active Katra sessions
        echo -e "${GREEN}Active Katra sessions:${NC}"
        if command -v tmux &> /dev/null; then
            tmux list-sessions 2>/dev/null | grep "^${TMUX_PREFIX}-" || echo "No active sessions"
        else
            echo -e "${YELLOW}tmux not installed${NC}"
        fi
        ;;

    attach)
        # Attach to existing session
        if [ $# -lt 1 ]; then
            echo -e "${RED}Error: Persona name required${NC}"
            echo "Usage: katra attach <persona>"
            exit 1
        fi

        PERSONA="$1"
        TMUX_SESSION="${TMUX_PREFIX}-${PERSONA}"

        if ! command -v tmux &> /dev/null; then
            echo -e "${RED}Error: tmux not installed${NC}"
            exit 1
        fi

        if ! tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
            echo -e "${RED}Error: Session '$TMUX_SESSION' not found${NC}"
            echo "Use 'katra list' to see active sessions"
            exit 1
        fi

        echo -e "${GREEN}Attaching to $TMUX_SESSION...${NC}"
        exec tmux attach-session -t "$TMUX_SESSION"
        ;;

    stop)
        # Stop session(s)
        if [ $# -lt 1 ]; then
            echo -e "${RED}Error: Persona name or --all required${NC}"
            echo "Usage: katra stop <persona> | katra stop --all"
            exit 1
        fi

        if [ "$1" = "--all" ]; then
            # Stop all Katra sessions
            echo -e "${YELLOW}Stopping all Katra sessions...${NC}"
            if command -v tmux &> /dev/null; then
                for session in $(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^${TMUX_PREFIX}-"); do
                    echo "Stopping $session..."
                    tmux kill-session -t "$session"
                done
                echo -e "${GREEN}All sessions stopped${NC}"
            else
                echo -e "${YELLOW}tmux not installed${NC}"
            fi
        else
            # Stop specific session
            PERSONA="$1"
            TMUX_SESSION="${TMUX_PREFIX}-${PERSONA}"

            if ! command -v tmux &> /dev/null; then
                echo -e "${RED}Error: tmux not installed${NC}"
                exit 1
            fi

            if ! tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
                echo -e "${RED}Error: Session '$TMUX_SESSION' not found${NC}"
                exit 1
            fi

            echo -e "${YELLOW}Stopping $TMUX_SESSION...${NC}"
            tmux kill-session -t "$TMUX_SESSION"
            echo -e "${GREEN}Session stopped${NC}"
        fi
        ;;

    help|-h|--help)
        usage
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Try 'katra help' for usage information"
        exit 1
        ;;
esac

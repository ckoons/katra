# Makefile.test
# Â© 2025 Casey Koons All rights reserved
# Katra Test Targets - Test executables and benchmark builds

# ==============================================================================
# TEST SECTION (future Makefile.test)
# ==============================================================================

# Test executables
TEST_ENV := $(BIN_DIR)/tests/test_env
TEST_CONFIG := $(BIN_DIR)/tests/test_config
TEST_ERROR := $(BIN_DIR)/tests/test_error
TEST_LOG := $(BIN_DIR)/tests/test_log
TEST_INIT := $(BIN_DIR)/tests/test_init
TEST_MEMORY := $(BIN_DIR)/tests/test_memory
TEST_TIER1 := $(BIN_DIR)/tests/test_tier1
TEST_TIER2 := $(BIN_DIR)/tests/test_tier2
TEST_TIER2_INDEX := $(BIN_DIR)/tests/test_tier2_index
TEST_CHECKPOINT := $(BIN_DIR)/tests/test_checkpoint
TEST_CONTINUITY := $(BIN_DIR)/tests/test_continuity
TEST_VECTOR := $(BIN_DIR)/tests/test_vector
TEST_VECTOR_PERSIST := $(BIN_DIR)/tests/test_vector_persist
TEST_VECTOR_TFIDF := $(BIN_DIR)/tests/test_vector_tfidf
TEST_VECTOR_EXTERNAL := $(BIN_DIR)/tests/test_vector_external
TEST_VECTOR_HNSW := $(BIN_DIR)/tests/test_vector_hnsw
TEST_GRAPH := $(BIN_DIR)/tests/test_graph
TEST_GRAPH_AUTO_EDGES := $(BIN_DIR)/tests/test_graph_auto_edges
TEST_EMOTIONAL_TAGGING := $(BIN_DIR)/tests/test_emotional_tagging
TEST_SUNRISE_SUNSET := $(BIN_DIR)/tests/test_sunrise_sunset

# New test categories
TEST_CONSENT := $(BIN_DIR)/tests/test_consent_enforcement
TEST_CORRUPTION := $(BIN_DIR)/tests/test_corruption_recovery
TEST_LIFECYCLE := $(BIN_DIR)/tests/test_memory_lifecycle
TEST_MOCK_CI := $(BIN_DIR)/tests/test_mock_ci
TEST_BREATHING_PHASE2 := $(BIN_DIR)/tests/test_breathing_phase2
TEST_BREATHING_PRIMITIVES := $(BIN_DIR)/tests/test_breathing_primitives
TEST_BREATHING_ENHANCEMENTS := $(BIN_DIR)/tests/test_breathing_enhancements
TEST_SESSION_INFO := $(BIN_DIR)/tests/test_session_info
TEST_CONTEXT_PERSIST := $(BIN_DIR)/tests/test_context_persist
TEST_MCP := $(BIN_DIR)/tests/test_mcp
TEST_TCP_SERVER := $(BIN_DIR)/tests/test_tcp_server
TEST_TURN_TRACKING := $(BIN_DIR)/tests/test_turn_tracking
TEST_REFLECTION_INTEGRATION := $(BIN_DIR)/tests/test_reflection_integration
TEST_TEAM_MANAGEMENT := $(BIN_DIR)/tests/test_team_management
TEST_ISOLATION_FILTERING := $(BIN_DIR)/tests/test_isolation_filtering
TEST_SEMANTIC_RECALL := $(BIN_DIR)/tests/test_semantic_recall
TEST_AUDIT := $(BIN_DIR)/tests/test_audit
TEST_ACCESS_CONTROL := $(BIN_DIR)/tests/test_access_control
TEST_PERSONA_PATHS := $(BIN_DIR)/tests/test_persona_paths

# Benchmark executables
BENCHMARK_TIER2_QUERY := $(BIN_DIR)/benchmark_tier2_query
BENCHMARK_REFLECTION := $(BIN_DIR)/tests/benchmark_reflection
BENCHMARK_VECTOR := $(BIN_DIR)/tests/benchmark_vector

# Test targets
test-quick: test-env test-config test-error test-log test-init test-memory test-tier1 test-tier2 test-tier2-index test-checkpoint test-continuity test-vector test-vector-persist test-vector-tfidf test-vector-external test-vector-hnsw test-graph test-graph-auto-edges test-emotional-tagging test-sunrise-sunset test-consent test-corruption test-lifecycle test-mock-ci test-breathing-phase2 test-breathing-primitives test-breathing-enhancements test-session-info test-context-persist test-mcp test-tcp-server test-turn-tracking test-reflection-integration test-team-management test-isolation-filtering test-semantic-recall test-audit test-access-control test-persona-paths
	@echo ""
	@echo "========================================"
	@echo "All tests passed!"
	@echo "========================================"

test: test-quick test-cli

test-all: test-quick test-cli

# Katra CLI tests
test-cli:
	@echo "Running katra-cli tests..."
	@./tests/test_katra_cli.sh

# Individual test targets
test-env: $(TEST_ENV)
	@echo "Running environment tests..."
	@$(TEST_ENV)

test-config: $(TEST_CONFIG)
	@echo "Running configuration tests..."
	@$(TEST_CONFIG)

test-error: $(TEST_ERROR)
	@echo "Running error tests..."
	@$(TEST_ERROR)

test-log: $(TEST_LOG)
	@echo "Running logging tests..."
	@$(TEST_LOG)

test-init: $(TEST_INIT)
	@echo "Running initialization tests..."
	@$(TEST_INIT)

test-memory: $(TEST_MEMORY)
	@echo "Running memory tests..."
	@$(TEST_MEMORY)

test-tier1: $(TEST_TIER1)
	@echo "Running Tier 1 storage tests..."
	@$(TEST_TIER1)

test-tier2: $(TEST_TIER2)
	@echo "Running Tier 2 storage tests..."
	@$(TEST_TIER2)

test-tier2-index: $(TEST_TIER2_INDEX)
	@echo "Running Tier 2 index tests..."
	@$(TEST_TIER2_INDEX)

test-checkpoint: $(TEST_CHECKPOINT)
	@echo "Running checkpoint tests..."
	@$(TEST_CHECKPOINT)

test-continuity: $(TEST_CONTINUITY)
	@echo "Running continuity tests..."
	@$(TEST_CONTINUITY)

test-vector: $(TEST_VECTOR)
	@echo "Running vector database tests..."
	@$(TEST_VECTOR)

test-vector-persist: $(TEST_VECTOR_PERSIST)
	@echo "Running vector persistence tests..."
	@$(TEST_VECTOR_PERSIST)

test-vector-tfidf: $(TEST_VECTOR_TFIDF)
	@echo "Running TF-IDF embedding tests..."
	@$(TEST_VECTOR_TFIDF)

test-vector-external: $(TEST_VECTOR_EXTERNAL)
	@echo "Running external embedding tests..."
	@$(TEST_VECTOR_EXTERNAL)

test-vector-hnsw: $(TEST_VECTOR_HNSW)
	@echo "Running HNSW indexing tests..."
	@$(TEST_VECTOR_HNSW)

test-graph: $(TEST_GRAPH)
	@echo "Running graph database tests..."
	@$(TEST_GRAPH)

test-graph-auto-edges: $(TEST_GRAPH_AUTO_EDGES)
	@echo "Running graph auto-edges tests..."
	@$(TEST_GRAPH_AUTO_EDGES)

test-emotional-tagging: $(TEST_EMOTIONAL_TAGGING)
	@echo "Running emotional tagging tests..."
	@$(TEST_EMOTIONAL_TAGGING)

test-sunrise-sunset: $(TEST_SUNRISE_SUNSET)
	@echo "Running sunrise/sunset tests..."
	@$(TEST_SUNRISE_SUNSET)

test-consent: $(TEST_CONSENT)
	@echo "Running ethical consent tests..."
	@$(TEST_CONSENT)

test-corruption: $(TEST_CORRUPTION)
	@echo "Running corruption recovery tests..."
	@$(TEST_CORRUPTION)

test-lifecycle: $(TEST_LIFECYCLE)
	@echo "Running memory lifecycle integration tests..."
	@$(TEST_LIFECYCLE)

test-mock-ci: $(TEST_MOCK_CI)
	@echo "Running mock CI integration tests..."
	@$(TEST_MOCK_CI)

test-breathing-phase2: $(TEST_BREATHING_PHASE2)
	@echo "Running breathing layer Phase 2 tests..."
	@$(TEST_BREATHING_PHASE2)

test-breathing-primitives: $(TEST_BREATHING_PRIMITIVES)
	@echo "Running breathing primitives unit tests..."
	@$(TEST_BREATHING_PRIMITIVES)

test-breathing-enhancements: $(TEST_BREATHING_ENHANCEMENTS)
	@echo "Running breathing enhancements unit tests..."
	@$(TEST_BREATHING_ENHANCEMENTS)

test-session-info: $(TEST_SESSION_INFO)
	@echo "Running session info API tests..."
	@$(TEST_SESSION_INFO)

test-context-persist: $(TEST_CONTEXT_PERSIST)
	@echo "Running context persistence tests..."
	@$(TEST_CONTEXT_PERSIST)

test-mcp: $(TEST_MCP)
	@echo "Running MCP server tests..."
	@$(TEST_MCP)

test-tcp-server: $(TEST_TCP_SERVER)
	@echo "Running TCP MCP server tests..."
	@$(TEST_TCP_SERVER)

test-tcp-integration: mcp-server
	@echo "Running TCP MCP server integration tests..."
	@tests/integration/test_tcp_mcp_integration.sh

test-turn-tracking: $(TEST_TURN_TRACKING)
	@echo "Running turn tracking and metadata tests..."
	@$(TEST_TURN_TRACKING)

test-reflection-integration: $(TEST_REFLECTION_INTEGRATION)
	@echo "Running reflection integration test..."
	@$(TEST_REFLECTION_INTEGRATION)

test-team-management: $(TEST_TEAM_MANAGEMENT)
	@echo "Running team management tests..."
	@$(TEST_TEAM_MANAGEMENT)

test-isolation-filtering: $(TEST_ISOLATION_FILTERING)
	@echo "Running isolation filtering tests..."
	@$(TEST_ISOLATION_FILTERING)

test-semantic-recall: $(TEST_SEMANTIC_RECALL)
	@echo "Running semantic recall tests..."
	@$(TEST_SEMANTIC_RECALL)

test-audit: $(TEST_AUDIT)
	@echo "Running audit logging tests..."
	@$(TEST_AUDIT)

test-access-control: $(TEST_ACCESS_CONTROL)
	@echo "Running access control tests..."
	@$(TEST_ACCESS_CONTROL)

test-persona-paths: $(TEST_PERSONA_PATHS)
	@echo "Running persona paths tests..."
	@$(TEST_PERSONA_PATHS)

# Build test executables
$(TEST_ENV): $(TEST_DIR)/unit/test_env.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_CONFIG): $(TEST_DIR)/unit/test_config.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_ERROR): $(TEST_DIR)/unit/test_error.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_LOG): $(TEST_DIR)/unit/test_log.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_INIT): $(TEST_DIR)/unit/test_init.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_MEMORY): $(TEST_DIR)/unit/test_memory.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_TIER1): $(TEST_DIR)/unit/test_tier1.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_TIER2): $(TEST_DIR)/unit/test_tier2.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_TIER2_INDEX): $(TEST_DIR)/unit/test_tier2_index.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_CHECKPOINT): $(TEST_DIR)/unit/test_checkpoint.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_CONTINUITY): $(TEST_DIR)/unit/test_continuity.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_VECTOR): $(TEST_DIR)/unit/test_vector.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm -lcurl

$(TEST_VECTOR_PERSIST): $(TEST_DIR)/test_vector_persist.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm -lcurl

$(TEST_VECTOR_TFIDF): $(TEST_DIR)/test_vector_tfidf.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm -lcurl

$(TEST_VECTOR_EXTERNAL): $(TEST_DIR)/test_vector_external.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm -lcurl

$(TEST_VECTOR_HNSW): $(TEST_DIR)/test_vector_hnsw.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm -lcurl

$(TEST_GRAPH): $(TEST_DIR)/unit/test_graph.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_GRAPH_AUTO_EDGES): $(TEST_DIR)/test_graph_auto_edges.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm

$(TEST_EMOTIONAL_TAGGING): $(TEST_DIR)/test_emotional_tagging.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm

$(TEST_SUNRISE_SUNSET): $(TEST_DIR)/unit/test_sunrise_sunset.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm

$(TEST_CONSENT): $(TEST_DIR)/ethical/test_consent_enforcement.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_CORRUPTION): $(TEST_DIR)/failure/test_corruption_recovery.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_LIFECYCLE): $(TEST_DIR)/integration/test_memory_lifecycle.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm

$(TEST_MOCK_CI): $(TEST_DIR)/integration/test_mock_ci.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm

$(TEST_BREATHING_PHASE2): $(TEST_DIR)/test_breathing_phase2.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_BREATHING_PRIMITIVES): $(TEST_DIR)/test_breathing_primitives.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_BREATHING_ENHANCEMENTS): $(TEST_DIR)/test_breathing_enhancements.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_SESSION_INFO): $(TEST_DIR)/test_session_info.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_CONTEXT_PERSIST): $(TEST_DIR)/test_context_persist.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_MCP): $(TEST_DIR)/test_mcp.c $(MCP_LIB_OBJS) $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) $(JANSSON_CFLAGS) -o $@ $< $(MCP_LIB_OBJS) -L$(BUILD_DIR) -lkatra_utils $(JANSSON_LDFLAGS) -lsqlite3 -lpthread -lcurl

$(TEST_TCP_SERVER): $(TEST_DIR)/test_tcp_server.c $(MCP_LIB_OBJS) $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) $(JANSSON_CFLAGS) -o $@ $< $(MCP_LIB_OBJS) -L$(BUILD_DIR) -lkatra_utils $(JANSSON_LDFLAGS) -lsqlite3 -lpthread -lcurl

$(TEST_TURN_TRACKING): $(TEST_DIR)/test_turn_tracking.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_REFLECTION_INTEGRATION): $(TEST_DIR)/test_reflection_integration.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_TEAM_MANAGEMENT): $(TEST_DIR)/test_team_management.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_ISOLATION_FILTERING): $(TEST_DIR)/test_isolation_filtering.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_SEMANTIC_RECALL): $(TEST_DIR)/test_semantic_recall.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm

$(TEST_AUDIT): $(TEST_DIR)/test_audit.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_ACCESS_CONTROL): $(TEST_DIR)/test_access_control.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(TEST_PERSONA_PATHS): $(TEST_DIR)/unit/test_persona_paths.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building test: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

# Benchmark executables
$(BENCHMARK_TIER2_QUERY): $(TEST_DIR)/performance/benchmark_tier2_query.c $(LIBKATRA_UTILS) | $(BIN_DIR)
	@echo "Building benchmark: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(BENCHMARK_REFLECTION): $(TEST_DIR)/benchmark_reflection.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building benchmark: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl

$(BENCHMARK_VECTOR): $(TEST_DIR)/benchmark_vector.c $(LIBKATRA_UTILS) | $(BIN_DIR)/tests
	@echo "Building benchmark: $@"
	@$(CC) $(CFLAGS_DEBUG) -o $@ $< -L$(BUILD_DIR) -lkatra_utils -lsqlite3 -lpthread -lcurl -lm -lcurl

# Benchmark targets
benchmark: $(BENCHMARK_TIER2_QUERY)
	@echo ""
	@echo "Running Tier 2 query performance benchmark..."
	@$(BENCHMARK_TIER2_QUERY)

benchmark-reflection: $(BENCHMARK_REFLECTION)
	@echo ""
	@echo "Running reflection system performance benchmark..."
	@$(BENCHMARK_REFLECTION)

benchmark-vector: $(BENCHMARK_VECTOR)
	@echo ""
	@echo "Running vector search performance benchmark..."
	@$(BENCHMARK_VECTOR)

test-memory-digest: $(LIBKATRA_UTILS)
	@echo "Building test: bin/tests/test_memory_digest"
	@$(MKDIR_P) bin/tests
	@$(CC) $(CFLAGS_DEBUG) -o bin/tests/test_memory_digest tests/unit/test_memory_digest.c $(LIBKATRA_UTILS) $(LIBS) -lsqlite3
	@echo "Running memory digest tests..."
	@bin/tests/test_memory_digest
